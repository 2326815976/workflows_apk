name: Build Android APK

on:
  workflow_dispatch:
    inputs:
      build_id:
        description: 'Build ID from database'
        required: true
        type: string
      source_url:
        description: 'Android source zip download URL'
        required: true
        type: string
      callback_url:
        description: 'Callback URL for build completion notification'
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Download Android source
        run: |
          echo "Downloading source from: ${{ github.event.inputs.source_url }}"
          wget -O source.zip "${{ github.event.inputs.source_url }}"
          unzip -q source.zip
          ls -la

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: |
          find . -name "gradlew" -type f -exec chmod +x {} \;

      - name: Decode and setup keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > keystore.jks
          echo "Keystore file created"

      - name: Build Release APK with Gradle
        env:
          KEYSTORE_FILE: ../keystore.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          # 查找 gradlew 文件位置
          GRADLE_DIR=$(find . -name "gradlew" -type f | head -n 1 | xargs dirname)
          echo "Found gradlew in: $GRADLE_DIR"
          cd "$GRADLE_DIR"

          # 构建 Release APK（使用签名密钥）
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=$KEYSTORE_FILE \
            -Pandroid.injected.signing.store.password=$KEYSTORE_PASSWORD \
            -Pandroid.injected.signing.key.alias=$KEY_ALIAS \
            -Pandroid.injected.signing.key.password=$KEY_PASSWORD \
            --no-daemon --stacktrace

          # 查找生成的 APK
          find . -name "*.apk" -type f

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-${{ github.event.inputs.build_id }}
          path: |
            **/build/outputs/apk/release/*.apk
          retention-days: 7

      - name: Notify build completion
        if: always()
        run: |
          if [ -n "${{ github.event.inputs.callback_url }}" ]; then
            STATUS="${{ job.status }}"
            BUILD_ID="${{ github.event.inputs.build_id }}"

            # 获取 APK 下载链接
            ARTIFACT_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

            curl -X POST "${{ github.event.inputs.callback_url }}" \
              -H "Content-Type: application/json" \
              -d "{\"build_id\":\"$BUILD_ID\",\"status\":\"$STATUS\",\"artifact_url\":\"$ARTIFACT_URL\",\"run_id\":\"${{ github.run_id }}\"}" \
              || echo "Failed to send callback notification"
          fi
